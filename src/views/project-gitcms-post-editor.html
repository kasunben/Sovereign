<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Post</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
    <link rel="stylesheet" href="/css/global.css" />
  </head>
  <body class="page post-page" data-project-id="demo-project">
    {{> sidebar}} {{> userbar}}
    <main class="page__wrap">
      <header class="page__header">
        <div class="title__wrap">
          <h1 id="page-title" class="title__name">New Post</h1>
          <div id="page-desc" class="title__desc">
            Create or edit a post under this project.
          </div>
        </div>
        <div class="actions">
          <a class="chip" href="/" title="Back to dashboard">Back</a>
          <a
            id="preview-btn"
            class="chip chip--ghost"
            href="#"
            target="_blank"
            rel="noopener"
            >Preview</a
          >
          <button id="save-draft-btn" class="chip chip--primary" type="button">
            Save Draft
          </button>
          <button id="publish-btn" class="chip" type="button">Publish</button>
        </div>
      </header>

      <section class="grid">
        <article class="card">
          <div
            class="card__bar"
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              gap: 12px;
            "
          >
            <strong>Editor</strong>
            <div class="segmented">
              <button
                id="mode-md"
                class="chip chip--ghost"
                type="button"
                aria-pressed="true"
              >
                Markdown
              </button>
              <button
                id="mode-rtf"
                class="chip chip--ghost"
                type="button"
                aria-pressed="false"
              >
                Rich Text
              </button>
            </div>
          </div>
          <div class="card__body">
            <div class="row row--single">
              <div class="field">
                <label class="label" for="title">Title</label>
                <input
                  id="title"
                  class="input"
                  type="text"
                  placeholder="Post title"
                  value="Getting Started"
                />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label class="label" for="slug">Slug</label>
                <input
                  id="slug"
                  class="input"
                  type="text"
                  placeholder="e.g., getting-started"
                  value="getting-started"
                />
                <div class="help">Used to build the file path and URL.</div>
              </div>
              <div class="field">
                <label class="label">Path</label>
                <div id="pathPreview" class="help">
                  src/content/blog/getting-started.md
                </div>
              </div>
            </div>

            <!-- Markdown editor (default) -->
            <div id="md-wrap">
              <div class="field">
                <label class="label" for="md-editor">Markdown</label>
                <div class="editor-toolbar" id="md-toolbar">
                  <button class="editor-btn" data-md="h2" type="button">
                    H2
                  </button>
                  <button class="editor-btn" data-md="h3" type="button">
                    H3
                  </button>
                  <button class="editor-btn" data-md="bold" type="button">
                    <strong>B</strong>
                  </button>
                  <button class="editor-btn" data-md="italic" type="button">
                    <em>I</em>
                  </button>
                  <button class="editor-btn" data-md="ul" type="button">
                    • List
                  </button>
                  <button class="editor-btn" data-md="ol" type="button">
                    1. List
                  </button>
                  <button class="editor-btn" data-md="code" type="button">
                    Code
                  </button>
                  <button class="editor-btn" data-md="quote" type="button">
                    Quote
                  </button>
                  <span class="spacer"></span>
                  <button class="editor-btn" data-md="link" type="button">
                    Link
                  </button>
                </div>
                <textarea
                  id="md-editor"
                  class="textarea"
                  rows="16"
                  placeholder="Write your post in Markdown…"
                ></textarea>
              </div>
            </div>

            <!-- Rich text editor (secondary) -->
            <div id="rtf-wrap" hidden>
              <div class="field">
                <label class="label">Rich Text Editor</label>
                <div class="editor-toolbar" id="rt-toolbar">
                  <button class="editor-btn" data-cmd="bold" type="button">
                    <strong>B</strong>
                  </button>
                  <button class="editor-btn" data-cmd="italic" type="button">
                    <em>I</em>
                  </button>
                  <button
                    class="editor-btn"
                    data-cmd="formatBlock"
                    data-value="H2"
                    type="button"
                  >
                    H2
                  </button>
                  <button
                    class="editor-btn"
                    data-cmd="formatBlock"
                    data-value="H3"
                    type="button"
                  >
                    H3
                  </button>
                  <button
                    class="editor-btn"
                    data-cmd="insertUnorderedList"
                    type="button"
                  >
                    • List
                  </button>
                  <button
                    class="editor-btn"
                    data-cmd="insertOrderedList"
                    type="button"
                  >
                    1. List
                  </button>
                  <button
                    class="editor-btn"
                    data-cmd="formatBlock"
                    data-value="BLOCKQUOTE"
                    type="button"
                  >
                    Quote
                  </button>
                  <button
                    class="editor-btn"
                    data-cmd="insertHTML"
                    data-value="<pre><code></code></pre>"
                    type="button"
                  >
                    Code
                  </button>
                  <button class="editor-btn" id="link-btn" type="button">
                    Link
                  </button>
                  <span class="spacer"></span>
                  <button class="editor-btn" data-cmd="undo" type="button">
                    Undo
                  </button>
                  <button class="editor-btn" data-cmd="redo" type="button">
                    Redo
                  </button>
                  <button class="editor-btn" id="clear-btn" type="button">
                    Clear
                  </button>
                </div>
                <div
                  id="editor"
                  class="editor-area"
                  contenteditable="true"
                  spellcheck="true"
                >
                  <h2>Welcome</h2>
                  <p>This is a sample post.</p>
                </div>
              </div>
            </div>
          </div>
        </article>

        <aside class="card">
          <div class="card__bar"><strong>Post Meta</strong></div>
          <div class="card__body">
            <div class="field">
              <label class="label" for="excerpt">Excerpt</label>
              <textarea
                id="excerpt"
                class="textarea"
                placeholder="Short summary…"
              >
How to use this demo project.</textarea
              >
            </div>
            <div class="field">
              <label class="label" for="tags">Tags</label>
              <input
                id="tags"
                class="input"
                type="text"
                placeholder="comma,separated,tags"
                value="guide,intro"
              />
              <div class="help">Comma-separated (e.g., demo,intro)</div>
            </div>
            <div class="row">
              <div
                class="col"
                style="gap: 10px; display: flex; flex-direction: column"
              >
                <div class="field">
                  <label class="label" for="pubDate">Publish Date</label>
                  <input
                    id="pubDate"
                    class="input"
                    type="datetime-local"
                    value="2025-10-04T12:00"
                  />
                </div>
                <div class="field">
                  <label class="label" for="draft">Status</label>
                  <div style="display: flex; align-items: center; gap: 8px">
                    <input id="draft" type="checkbox" checked />
                    <span class="help">Draft</span>
                  </div>
                </div>
              </div>
            </div>

            <hr
              style="
                border: none;
                border-top: 1px solid var(--color-border-card);
                margin: 14px 0;
              "
            />

            <div class="meta-grid">
              <div class="subtle">Project</div>
              <div id="m-project">Sovereign Demo</div>
              <div class="subtle">Repo</div>
              <div id="m-repo">
                <a
                  href="https://github.com/example/sovereign-demo-content"
                  target="_blank"
                  rel="noopener"
                  >link</a
                >
              </div>
              <div class="subtle">Branch</div>
              <div id="m-branch">main</div>
              <div class="subtle">Content Dir</div>
              <div id="m-dir">src/content/blog</div>
            </div>

            <div
              id="danger-zone"
              class="danger-zone"
              style="margin-top: 14px; display: none"
            >
              <span class="subtle">Danger zone</span>
              <button id="delete-btn" class="chip chip--danger" type="button">
                Delete Post
              </button>
            </div>
          </div>
        </aside>
      </section>
    </main>

    <script>
      // Elements
      const $ = (id) => document.getElementById(id);
      const titleEl = $("title");
      const slugEl = $("slug");
      const pathPreviewEl = $("pathPreview");
      const mdWrap = $("md-wrap");
      const mdEditorEl = $("md-editor");
      const mdToolbar = $("md-toolbar");
      const rtfWrap = $("rtf-wrap");
      const editorEl = $("editor");
      const rtToolbar = $("rt-toolbar");
      const excerptEl = $("excerpt");
      const tagsEl = $("tags");
      const pubDateEl = $("pubDate");
      const draftEl = $("draft");
      const previewBtn = $("preview-btn");
      const saveDraftBtn = $("save-draft-btn");
      const publishBtn = $("publish-btn");
      const deleteBtn = $("delete-btn");
      const modeMdBtn = $("mode-md");
      const modeRtfBtn = $("mode-rtf");

      // Helpers
      const getContentDir = () =>
        (document.getElementById("m-dir")?.textContent || "")
          .trim()
          .replace(/^\/+|\/+$/g, "");

      function slugify(s) {
        return String(s || "")
          .toLowerCase()
          .normalize("NFKD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/^-+|-+$/g, "")
          .slice(0, 200);
      }
      function toPath(slug) {
        const dir = getContentDir();
        const fname = slug ? `${slug}.md` : "untitled.md";
        return dir ? `${dir}/${fname}` : fname;
      }
      function updatePathPreview() {
        pathPreviewEl.textContent = toPath(slugEl.value.trim());
      }

      // Minimal Markdown <-> HTML converters (best-effort)
      function markdownToHtml(md) {
        if (!md) return "";
        let html = md;

        // Escape basic
        html = html
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");

        // Code blocks ``` ```
        html = html.replace(
          /```([\s\S]*?)```/g,
          (_, code) => `<pre><code>${code.replace(/\n$/, "")}</code></pre>`,
        );

        // Headings
        html = html.replace(/^### (.*)$/gm, "<h3>$1</h3>");
        html = html.replace(/^## (.*)$/gm, "<h2>$1</h2>");
        html = html.replace(/^# (.*)$/gm, "<h1>$1</h1>");

        // Blockquote
        html = html.replace(/^\> (.*)$/gm, "<blockquote>$1</blockquote>");

        // Lists
        html = html.replace(/^(?:\d+\.\s+)(.*)$/gm, "<ol><li>$1</li></ol>");
        html = html.replace(/^(?:-\s+|\*\s+)(.*)$/gm, "<ul><li>$1</li></ul>");
        // Merge adjacent single-item lists
        html = html.replace(/<\/ul>\n<ul>/g, "").replace(/<\/ol>\n<ol>/g, "");

        // Inline
        html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        html = html.replace(/\*(.+?)\*/g, "<em>$1</em>");
        html = html.replace(/`([^`]+?)`/g, "<code>$1</code>");
        html = html.replace(
          /\[([^\]]+?)\]\(([^)]+?)\)/g,
          '<a href="$2" rel="noopener" target="_blank">$1</a>',
        );

        // Paragraphs
        html = html
          .split(/\n{2,}/)
          .map((blk) => {
            if (/^\s*<(h\d|pre|blockquote|ul|ol)/.test(blk)) return blk;
            return `<p>${blk.replace(/\n/g, "<br/>")}</p>`;
          })
          .join("\n");

        return html;
      }

      function htmlToMarkdown(html) {
        if (!html) return "";
        // Work on a detached container
        const div = document.createElement("div");
        div.innerHTML = html;

        // Convert common nodes
        const walk = (node) => {
          if (node.nodeType === 3) {
            return node.nodeValue.replace(/\s+/g, " ");
          }
          if (node.nodeType !== 1) return "";

          const tag = node.tagName.toLowerCase();
          const childMd = Array.from(node.childNodes).map(walk).join("");

          switch (tag) {
            case "h1":
              return `# ${childMd}\n\n`;
            case "h2":
              return `## ${childMd}\n\n`;
            case "h3":
              return `### ${childMd}\n\n`;
            case "strong":
            case "b":
              return `**${childMd}**`;
            case "em":
            case "i":
              return `*${childMd}*`;
            case "code":
              if (
                node.parentElement &&
                node.parentElement.tagName.toLowerCase() === "pre"
              ) {
                return childMd; // handled by pre
              }
              return "`" + childMd + "`";
            case "pre":
              return "```\n" + childMd + "\n```\n\n";
            case "blockquote":
              return `> ${childMd}\n\n`;
            case "ul":
              return (
                Array.from(node.children)
                  .map((li) => `- ${walk(li)}\n`)
                  .join("") + "\n"
              );
            case "ol":
              return (
                Array.from(node.children)
                  .map((li, i) => `${i + 1}. ${walk(li)}\n`)
                  .join("") + "\n"
              );
            case "li":
              return childMd;
            case "a": {
              const href = node.getAttribute("href") || "#";
              return `[${childMd}](${href})`;
            }
            case "br":
              return "  \n";
            case "p":
              return `${childMd}\n\n`;
            default:
              return childMd;
          }
        };

        return walk(div)
          .replace(/\n{3,}/g, "\n\n")
          .trim();
      }

      // Mode management
      let editorMode = "markdown"; // 'markdown' | 'rtf'

      function setMode(mode) {
        if (mode === editorMode) return;
        // Sync content from current mode to the other
        if (editorMode === "markdown" && mode === "rtf") {
          const md = mdEditorEl.value;
          editorEl.innerHTML = markdownToHtml(md);
        } else if (editorMode === "rtf" && mode === "markdown") {
          const html = editorEl.innerHTML;
          mdEditorEl.value = htmlToMarkdown(html);
        }

        editorMode = mode;

        // Toggle UI
        const isMd = editorMode === "markdown";
        mdWrap.hidden = !isMd;
        rtfWrap.hidden = isMd;
        modeMdBtn.setAttribute("aria-pressed", isMd ? "true" : "false");
        modeRtfBtn.setAttribute("aria-pressed", isMd ? "false" : "true");
      }

      // Initial path preview based on current slug/content dir
      updatePathPreview();

      // Auto-generate slug from title until user edits slug manually
      let slugTouched = false;
      slugEl.addEventListener("input", () => {
        slugTouched = true;
        updatePathPreview();
      });
      titleEl.addEventListener("input", () => {
        if (!slugTouched) {
          slugEl.value = slugify(titleEl.value);
          updatePathPreview();
        }
      });

      // Wire mode toggles
      modeMdBtn.addEventListener("click", () => setMode("markdown"));
      modeRtfBtn.addEventListener("click", () => setMode("rtf"));

      // Markdown toolbar actions (simple inserts around selection)
      function wrapSelectionInTextarea(textarea, before, after = before) {
        const start = textarea.selectionStart ?? 0;
        const end = textarea.selectionEnd ?? 0;
        const val = textarea.value;
        const selected = val.slice(start, end);
        const replacement = before + selected + after;
        textarea.value = val.slice(0, start) + replacement + val.slice(end);
        // Restore selection
        const pos = start + replacement.length;
        textarea.focus();
        textarea.setSelectionRange(pos, pos);
      }

      mdToolbar.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-md]");
        if (!btn) return;
        const cmd = btn.getAttribute("data-md");
        switch (cmd) {
          case "h2":
            wrapSelectionInTextarea(mdEditorEl, "## ", "");
            break;
          case "h3":
            wrapSelectionInTextarea(mdEditorEl, "### ", "");
            break;
          case "bold":
            wrapSelectionInTextarea(mdEditorEl, "**");
            break;
          case "italic":
            wrapSelectionInTextarea(mdEditorEl, "*");
            break;
          case "ul":
            wrapSelectionInTextarea(mdEditorEl, "- ", "");
            break;
          case "ol":
            wrapSelectionInTextarea(mdEditorEl, "1. ", "");
            break;
          case "code":
            wrapSelectionInTextarea(mdEditorEl, "```\n", "\n```");
            break;
          case "quote":
            wrapSelectionInTextarea(mdEditorEl, "> ", "");
            break;
          case "link": {
            const url = prompt("Enter URL");
            if (!url) return;
            wrapSelectionInTextarea(mdEditorEl, "[", `](${url})`);
            break;
          }
        }
      });

      // Rich text toolbar
      document
        .querySelectorAll("#rt-toolbar .editor-btn[data-cmd]")
        .forEach((btn) => {
          btn.addEventListener("click", () => {
            const cmd = btn.getAttribute("data-cmd");
            const val = btn.getAttribute("data-value") || null;
            if (cmd === "insertHTML" && val) {
              document.execCommand("insertHTML", false, val);
            } else if (cmd === "formatBlock") {
              document.execCommand("formatBlock", false, val);
            } else {
              document.execCommand(cmd, false, val);
            }
            editorEl.focus();
          });
        });
      $("clear-btn").addEventListener("click", () => {
        editorEl.innerHTML = "";
        editorEl.focus();
      });
      $("link-btn").addEventListener("click", () => {
        const url = prompt("Enter URL");
        if (url) document.execCommand("createLink", false, url);
        editorEl.focus();
      });

      // Seed Markdown editor from initial Rich Text content and set default to Markdown mode
      mdEditorEl.value = htmlToMarkdown(editorEl.innerHTML || "<p></p>");
      setMode("markdown");

      // Collect payload from DOM (now includes both html + markdown)
      function collectPayload(overrides = {}) {
        let pubISO = null;
        if (pubDateEl.value) {
          try {
            const d = new Date(pubDateEl.value);
            pubISO = d.toISOString();
          } catch {}
        }
        const projectId = document.body.dataset.projectId || "demo-project";

        // Capture content in both formats (canonical = Markdown)
        let contentMarkdown, contentHtml;
        if (editorMode === "markdown") {
          contentMarkdown = mdEditorEl.value;
          contentHtml = markdownToHtml(contentMarkdown);
        } else {
          contentHtml = editorEl.innerHTML;
          contentMarkdown = htmlToMarkdown(contentHtml);
        }

        return {
          projectId,
          path: toPath(slugEl.value.trim()),
          title: titleEl.value.trim(),
          excerpt: excerptEl.value.trim(),
          pubDate: pubISO,
          draft: !!draftEl.checked,
          tags: tagsEl.value.trim(),
          contentHtml,
          contentMarkdown,
          editorMode,
          ...overrides,
        };
      }

      // Demo actions
      previewBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const { contentHtml } = collectPayload();
        const w = window.open("", "_blank", "noopener");
        if (w) {
          w.document.write(
            `<meta charset="utf-8"><title>Preview</title>${contentHtml}`,
          );
          w.document.close();
        }
      });

      saveDraftBtn.addEventListener("click", async () => {
        const payload = collectPayload({ draft: true });
        console.log("Save draft payload:", payload);
        alert("Draft saved (demo). Check console for payload.");
      });
      publishBtn.addEventListener("click", async () => {
        const base = collectPayload();
        const payload = {
          ...base,
          draft: false,
          pubDate: base.pubDate || new Date().toISOString(),
        };
        console.log("Publish payload:", payload);
        alert("Publish requested (demo). Check console for payload.");
      });
      deleteBtn?.addEventListener("click", async () => {
        if (!confirm("Delete this post?")) return;
        const path = toPath(slugEl.value.trim());
        console.log("Delete requested for:", {
          projectId: document.body.dataset.projectId || "demo-project",
          path,
        });
        alert("Delete requested (demo). Check console for payload.");
      });
    </script>
  </body>
</html>
