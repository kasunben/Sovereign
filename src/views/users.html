<!doctype html>
<html lang="en">
  <head>
    {{> layout/head}}
    <link rel="stylesheet" href="/css/components/breadcrumb.css" />
    <link rel="stylesheet" href="/css/components/modal.css" />
    <style>
      /* Scoped: icon button next to "All Users" */
      .card__bar .icon-user-add {
        margin: -5px 0 0 -2px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 6px;
        background: transparent;
        color: var(--fg, #111);
        text-decoration: none;
        vertical-align: middle;
      }
      .card__bar .icon-user-add:hover {
        background: #eee;
        color: blue;
      }
      .card__bar .icon-user-add svg {
        width: 18px;
        height: 18px;
      }
      span.email {
        font-size: 13px;
        color: #334155;
      }
    </style>
  </head>
  <body class="page users-page">
    {{> sidebar users_active=true}} {{> userbar show_user_menu=true}}

    <main class="page__wrap">
      <h2 class="projects__title">Users</h2>

      <!-- Breadcrumb -->
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <ol class="breadcrumb__list">
          <li class="breadcrumb__item">
            <a class="breadcrumb__link" href="/">Home</a>
          </li>
          <li class="breadcrumb__item" aria-current="page">
            <span class="breadcrumb__current">Users</span>
          </li>
        </ol>
      </nav>

      {{> modal/modal-runtime}} {{> modal/create-user}}

      <section class="grid">
        <article class="card" style="grid-column: 1 / -1">
          <div class="card__bar">
            <div>
              <strong>All Users</strong>
              <a
                href="javascript:void(0)"
                class="icon-user-add"
                aria-label="Create new user"
                title="Create new user"
                data-modal-open="create-user"
                aria-haspopup="dialog"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z"
                  />
                </svg>
              </a>
            </div>
            <input
              id="user-search"
              class="search"
              type="search"
              placeholder="Search usersâ€¦"
              autocomplete="off"
            />
          </div>

          <div class="card__body table-wrap">
            <table aria-label="Users">
              <thead>
                <tr>
                  <th style="width: 28%">User</th>
                  <th style="width: 22%">Email</th>
                  <th style="width: 12%">Role</th>
                  <th style="width: 18%">Projects</th>
                  <th style="width: 18%">Created</th>
                  <th style="width: 1%">Actions</th>
                </tr>
              </thead>
              <tbody id="users-tbody">
                {{#each users}}
                <tr
                  data-id="{{id}}"
                  data-name="{{displayName}}"
                  data-email="{{email}}"
                  data-role="{{roleLabel}}"
                >
                  <td>
                    <div class="title">{{displayName}}</div>
                    <div class="subtle">{{email}}</div>
                  </td>
                  <td><span class="email">{{email}}</span></td>
                  <td><span class="badge">{{roleLabel}}</span></td>
                  <td>
                    <span class="subtle">{{projectsAssigned}} assigned</span>
                  </td>
                  <td>
                    <time datetime="{{createdAtISO}}"
                      >{{createdAtDisplay}}</time
                    >
                  </td>
                  <td>
                    <div class="row-actions">
                      <a class="chip" href="javascript:void(0)">Edit</a>
                      <a class="chip" href="javascript:void(0)">Roles</a>
                      <a class="chip" href="javascript:void(0)">Projects</a>
                      <button
                        class="chip chip--danger"
                        type="button"
                        data-action="delete"
                        data-id="{{id}}"
                      >
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
                {{/each}}

                <!-- Empty state row (shown when search filters out all rows) -->
                <tr class="empty-row" hidden>
                  <td colspan="6" class="empty">No users found</td>
                </tr>
              </tbody>
            </table>
          </div>
        </article>
      </section>
    </main>

    <script>
      // Simple client-side search on static rows
      const search = document.getElementById("user-search");
      const tbody = document.getElementById("users-tbody");

      const rows = Array.from(tbody.querySelectorAll("tr:not(.empty-row)"));
      const emptyRow = tbody.querySelector(".empty-row");

      function applySearch() {
        const q = (search.value || "").trim().toLowerCase();
        let shown = 0;
        rows.forEach((tr) => {
          const hay =
            `${tr.dataset.name} ${tr.dataset.email} ${tr.dataset.role}`.toLowerCase();
          const match = !q || hay.includes(q);
          tr.hidden = !match;
          if (match) shown++;
        });
        if (emptyRow) emptyRow.hidden = shown !== 0;
      }

      search?.addEventListener("input", applySearch);
      applySearch();

      // Delegated delete (demo only)
      document.addEventListener("click", (e) => {
        const btn = e.target.closest('button[data-action="delete"]');
        if (!btn) return;
        const id = btn.getAttribute("data-id");
        if (!id) return;
        if (!confirm("Delete this user?")) return;
        // Replace with real DELETE call later
        const tr = tbody.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
        tr?.remove();
        applySearch();
      });
    </script>
  </body>
</html>
