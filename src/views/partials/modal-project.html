<div data-modal="project" class="modal" hidden>
  <div class="modal__backdrop" data-modal-close aria-hidden="true"></div>
  <div
    class="modal__dialog"
    role="dialog"
    aria-modal="true"
    aria-labelledby="project-modal-title"
  >
    <header class="modal__header">
      <h3 id="project-modal-title" class="modal__title">Create new project</h3>
      <!-- <button
        type="button"
        class="modal__close"
        data-modal-close
        aria-label="Close"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
          focusable="false"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-4"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
      </button> -->
    </header>

    <div class="modal__body">
      <form class="modal__form" data-modal-form novalidate>
        <div class="modal__field">
          <label class="modal__label" for="project-name-input">Name</label>
          <input
            id="project-name-input"
            class="modal__input input"
            type="text"
            maxlength="120"
            placeholder="Eg. My Workspace"
            data-modal-autofocus
          />
        </div>
        <div class="modal__field">
          <label class="modal__label" for="project-type-input">Type</label>
          <select id="project-type-input" class="modal__input input">
            <option value="gitcms" selected>GitCMS</option>
            <option value="papertrail">PaperTrail</option>
            <option value="workspace">Workspace</option>
          </select>
        </div>
        <div class="modal__field">
          <label class="modal__label" for="project-scope-input">Scope</label>
          <select id="project-scope-input" class="modal__input input">
            <option value="private" selected>Private</option>
            <option value="org">Organization</option>
            <option value="public">Public</option>
          </select>
        </div>
        <div class="modal__field">
          <label class="modal__label" for="project-desc-input"
            >Description</label
          >
          <textarea
            id="project-desc-input"
            class="modal__input input"
            rows="3"
            maxlength="500"
            placeholder="Briefly describe the projectâ€”purpose, key features, and initial goals."
          ></textarea>
        </div>

        <div
          class="modal__alert modal__alert--error"
          data-modal-alert="error"
          style="display: none"
        ></div>
      </form>
    </div>

    <footer class="modal__footer">
      <button type="button" class="chip button" data-modal-close>Cancel</button>
      <button
        type="submit"
        class="chip chip--primary button button--primary"
        formnovalidate
        data-modal-submit
      >
        Create
      </button>
    </footer>
  </div>

  <script>
    // Project-specific submission, still generic DOM lookups within the modal
    (function initProjectModal(
      root = document.querySelector('[data-modal="project"]'),
    ) {
      if (!root) return;
      const form = root.querySelector("[data-modal-form]");
      const err = root.querySelector('[data-modal-alert="error"]');
      const nameEl = root.querySelector("#project-name-input");
      const typeEl = root.querySelector("#project-type-input");
      const scopeEl = root.querySelector("#project-scope-input");
      const desEl = root.querySelector("#project-desc-input");

      // Reset form and error when modal is closed
      function resetForm() {
        form?.reset();
        if (err) {
          err.textContent = "";
          err.style.display = "none";
        }
      }
      // Observe the hidden attribute toggled by the modal runtime
      const modalObserver = new MutationObserver((mutList) => {
        for (const m of mutList) {
          if (m.type === "attributes" && m.attributeName === "hidden") {
            if (root.hasAttribute("hidden")) resetForm();
          }
        }
      });
      modalObserver.observe(root, {
        attributes: true,
        attributeFilter: ["hidden"],
      });

      root.addEventListener("click", async (e) => {
        const submit = e.target.closest("[data-modal-submit]");
        if (!submit) return;
        e.preventDefault();
        if (err) err.style.display = "none";

        const payload = {
          name: (nameEl?.value || "Untitled").trim().slice(0, 120),
          type: typeEl?.value || "gitcms",
          scope: scopeEl?.value || "private",
          des: (desEl?.value || "").trim().slice(0, 500),
        };
        if (!payload.name) {
          nameEl?.focus();
          return;
        }

        try {
          const resp = await fetch("/api/project", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok)
            throw new Error(data?.error || "Failed to create project");

          window.ModalRuntime?.close(root);
          if (data?.id)
            window.location.href = `/p/${encodeURIComponent(data.id)}`;
          else window.location.reload();
        } catch (ex) {
          if (err) {
            err.textContent = ex?.message || "Failed to create project";
            err.style.display = "block";
          }
        }
      });
    })();
  </script>
</div>
