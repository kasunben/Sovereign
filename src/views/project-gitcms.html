<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Project</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/global.css" />
  </head>
  <body class="page project-page">
    {{> sidebar}} {{> userbar}}
    <main class="page__wrap">
      <header class="page__header">
        <div class="title__wrap">
          <h1 id="project-title" class="title__name">Sovereign Demo</h1>
          <div id="project-sub" class="title__desc">
            Public demo project seeded by prisma/seed.mjs
          </div>
        </div>
        <div class="row-actions">
          <a
            id="new-post-btn"
            class="chip chip--primary"
            href="/p/{{project.id}}/post/new"
            >New Post</a
          >
          <a
            id="edit-project-btn"
            class="chip chip--ghost"
            href="/p/{{project.id}}/settings"
            >Project Settings</a
          >
        </div>
      </header>

      <section class="grid">
        <!-- Posts -->
        <article class="card">
          <div class="card__bar">
            <strong>Posts</strong>
            <input
              id="post-search"
              class="search"
              type="search"
              placeholder="Search posts…"
              autocomplete="off"
            />
          </div>
          <div class="card__body table-wrap">
            <table id="posts-table" aria-label="Posts">
              <thead>
                <tr>
                  <th style="width: 40%">Title</th>
                  <th>Path</th>
                  <th>Tags</th>
                  <th>Status</th>
                  <th>Published</th>
                  <th style="width: 1%">Actions</th>
                </tr>
              </thead>
              <tbody id="posts-tbody">
                <!-- Loading state -->
                <tr class="loading-row" hidden>
                  <td colspan="6" class="empty">Loading posts…</td>
                </tr>
                <!-- Error state -->
                <tr class="error-row" hidden>
                  <td colspan="6" class="empty">
                    Failed to load posts
                    <button id="retry-posts" class="chip" type="button">
                      Retry
                    </button>
                  </td>
                </tr>
                <!-- Empty state (shown by script when filtered or no posts) -->
                <tr class="empty-row" hidden>
                  <td colspan="6" class="empty">No posts found</td>
                </tr>
              </tbody>
            </table>
          </div>
        </article>

        <!-- Project Meta -->
        <aside class="card">
          <div class="card__bar"><strong>Project Meta</strong></div>
          <div class="card__body">
            <div
              style="
                display: grid;
                grid-template-columns: 140px 1fr;
                row-gap: 8px;
                column-gap: 12px;
              "
            >
              <div class="subtle">Name</div>
              <div id="m-name">Sovereign Demo</div>

              <div class="subtle">Status</div>
              <div id="m-status"><span class="badge">published</span></div>

              <div class="subtle">Posts</div>
              <div id="m-count">2</div>

              <div class="subtle">Repo</div>
              <div id="m-repo">
                <a
                  href="{{project.gitcms.repoUrl}}"
                  target="_blank"
                  rel="noopener"
                >
                  link
                </a>
              </div>

              <div class="subtle">Branch</div>
              <div id="m-branch">main</div>

              <div class="subtle">Content Dir</div>
              <div id="m-dir">src/content/blog</div>

              <div class="subtle">Live URL</div>
              <div id="m-live">—</div>

              <div class="subtle">Created</div>
              <div id="m-created">
                <time datetime="2025-10-04T12:00:00Z">Oct 4, 2025, 12:00</time>
              </div>

              <div class="subtle">Updated</div>
              <div id="m-updated">
                <time datetime="2025-10-04T12:00:00Z">Oct 4, 2025, 12:00</time>
              </div>
            </div>
          </div>
        </aside>
      </section>
    </main>

    <script>
      // Resolve project id for API calls
      function resolveProjectId() {
        // 1) From "New Post" link
        const a = document.getElementById("new-post-btn");
        if (a?.href) {
          const m = a.href.match(/\/p\/([^/]+)/);
          if (m) return m[1];
        }
        // 2) From location path (/p/:id or /p/:id/...)
        const m2 = location.pathname.match(/\/p\/([^/]+)/);
        if (m2) return m2[1];
        return null;
      }

      const search = document.getElementById("post-search");
      const tbody = document.getElementById("posts-tbody");
      let rows = Array.from(
        tbody.querySelectorAll(
          "tr:not(.empty-row):not(.loading-row):not(.error-row)",
        ),
      );
      const emptyRow = tbody.querySelector(".empty-row");
      const loadingRow = tbody.querySelector(".loading-row");
      const errorRow = tbody.querySelector(".error-row");
      const table = document.getElementById("posts-table");

      function applySearch() {
        const q = (search.value || "").trim().toLowerCase();
        let shown = 0;
        rows.forEach((tr) => {
          const hay =
            `${tr.dataset.title} ${tr.dataset.path} ${tr.dataset.tags || ""} ${tr.dataset.excerpt || ""}`.toLowerCase();
          const match = !q || hay.includes(q);
          tr.hidden = !match;
          if (match) shown++;
        });
        if (emptyRow) emptyRow.hidden = shown !== 0;
      }

      function fmtDate(d) {
        try {
          const dt = new Date(d);
          const iso = dt.toISOString();
          const label = dt.toLocaleString();
          return { iso, label };
        } catch {
          return { iso: "", label: "—" };
        }
      }

      function makePostRow(projectId, post) {
        const title = post.filename.replace(/\.md$/i, "");
        const hrefEdit = `/p/${projectId}/post/${encodeURIComponent(post.filename)}?edit=true`;
        const { iso, label } = post.modified
          ? fmtDate(post.modified)
          : { iso: "", label: "—" };

        const tr = document.createElement("tr");
        tr.dataset.title = title;
        tr.dataset.path = post.filename;
        tr.dataset.tags = "";
        tr.dataset.excerpt = "";

        tr.innerHTML = `
          <td>
            <div class="title">${title}</div>
            <div class="subtle"></div>
          </td>
          <td>${post.filename}</td>
          <td><!-- tags --></td>
          <td><span class="badge">Published</span></td>
          <td>${iso ? `<time datetime="${iso}">${label}</time>` : "—"}</td>
          <td>
            <div class="row-actions">
              <a class="chip" href="${hrefEdit}">Edit</a>
              <button class="chip chip--danger" type="button" data-action="delete" data-id="${post.filename}">
                Delete
              </button>
            </div>
          </td>
        `;
        return tr;
      }

      function clearDataRows() {
        Array.from(
          tbody.querySelectorAll(
            "tr:not(.empty-row):not(.loading-row):not(.error-row)",
          ),
        ).forEach((n) => n.remove());
        rows = [];
      }

      function setLoading(isLoading) {
        if (table)
          table.setAttribute("aria-busy", isLoading ? "true" : "false");
        if (search) search.disabled = !!isLoading;

        if (loadingRow) loadingRow.hidden = !isLoading;
        if (errorRow) errorRow.hidden = true; // hide error on new attempt
        if (emptyRow) emptyRow.hidden = true;

        if (isLoading) {
          clearDataRows();
          const countEl = document.getElementById("m-count");
          if (countEl) countEl.textContent = "—";
        }
      }

      async function loadPosts() {
        const projectId = resolveProjectId();
        if (!projectId) {
          console.warn("Project id not found in URL");
          return;
        }

        setLoading(true);

        try {
          const resp = await fetch(
            `/api/project/${encodeURIComponent(projectId)}/gitcms/posts`,
            { method: "GET", headers: { Accept: "application/json" } },
          );

          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}`);
          }

          const data = await resp.json();
          const posts = Array.isArray(data.posts) ? data.posts : [];

          // Render
          const frag = document.createDocumentFragment();
          posts.forEach((p) => frag.appendChild(makePostRow(projectId, p)));
          tbody.appendChild(frag);

          // Update rows ref
          rows = Array.from(
            tbody.querySelectorAll(
              "tr:not(.empty-row):not(.loading-row):not(.error-row)",
            ),
          );
          if (emptyRow) emptyRow.hidden = rows.length !== 0;

          // Update meta count
          const countEl = document.getElementById("m-count");
          if (countEl) countEl.textContent = String(posts.length);

          setLoading(false);
          applySearch();
        } catch (e) {
          console.error("Error loading posts:", e);
          setLoading(false);
          // Show error row
          if (errorRow) errorRow.hidden = false;
          if (emptyRow) emptyRow.hidden = true;
        }
      }

      // Wire search and initial render
      search?.addEventListener("input", applySearch);
      loadPosts();

      // Retry handler
      tbody.addEventListener("click", (e) => {
        const btn = e.target.closest("#retry-posts");
        if (btn) {
          loadPosts();
        }
      });

      function setRowBusy(tr, busy, btn) {
        if (!tr) return;
        tr.setAttribute("aria-busy", busy ? "true" : "false");
        tr.querySelectorAll("button").forEach((b) => (b.disabled = !!busy));
        // Visually block links during busy to avoid interactions
        tr.querySelectorAll("a").forEach((a) => {
          if (busy) {
            a.setAttribute("aria-disabled", "true");
            a.style.pointerEvents = "none";
            a.style.opacity = "0.6";
          } else {
            a.removeAttribute("aria-disabled");
            a.style.pointerEvents = "";
            a.style.opacity = "";
          }
        });
        if (btn) {
          if (busy) {
            btn.dataset.prevText = btn.textContent;
            btn.textContent = "Deleting…";
          } else if (btn.dataset.prevText) {
            btn.textContent = btn.dataset.prevText;
            delete btn.dataset.prevText;
          }
        }
      }

      // Replace the existing client-only delete handler with API-backed deletion
      document.addEventListener("click", async (e) => {
        const btn = e.target.closest('button[data-action="delete"]');
        if (!btn) return;

        const filename = btn.getAttribute("data-id");
        if (!filename) return;

        const projectId = resolveProjectId();
        if (!projectId) {
          alert("Project id not found.");
          return;
        }

        if (!confirm(`Delete post "${filename}"?`)) return;

        const tr = btn.closest("tr");
        setRowBusy(tr, true, btn);

        try {
          const resp = await fetch(
            `/api/project/${encodeURIComponent(projectId)}/gitcms/posts/${encodeURIComponent(
              filename,
            )}`,
            {
              method: "DELETE",
              headers: { Accept: "application/json" },
              credentials: "same-origin",
            },
          );

          if (!resp.ok) {
            let msg = `HTTP ${resp.status}`;
            try {
              const data = await resp.json();
              if (data?.error) msg = data.error;
            } catch {}
            throw new Error(msg);
          }

          // Remove row and update state
          tr?.remove();
          rows = Array.from(
            tbody.querySelectorAll(
              "tr:not(.empty-row):not(.loading-row):not(.error-row)",
            ),
          );

          // Update count
          const countEl = document.getElementById("m-count");
          if (countEl) countEl.textContent = String(rows.length);

          // Show empty state if needed and re-apply filter
          if (emptyRow) emptyRow.hidden = rows.length !== 0;
          applySearch();
        } catch (err) {
          console.error("Delete failed:", err);
          alert(`Failed to delete: ${err?.message || err}`);
        } finally {
          // If row still exists (failed), restore UI
          if (document.body.contains(tr)) setRowBusy(tr, false, btn);
        }
      });
    </script>
  </body>
</html>
